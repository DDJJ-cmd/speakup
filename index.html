<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />

  <!-- iPhone向け -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="SpeakUp" />

  <title>SpeakUp</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111b33;
      --border:rgba(255,255,255,.12);
      --muted:#a9b5d6;
      --text:#e9eefc;
      --accent1:rgba(110,231,255,.18);
      --accent2:rgba(124,255,166,.14);
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --radius:16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:16px;
      padding-bottom:88px; /* bottom nav */
    }

    h1{ margin:6px 0 4px; font-size:22px; letter-spacing:.2px; }
    .sub{
      margin:0 0 14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      margin:12px 0;
      box-shadow:var(--shadow);
    }

    .card h2{
      margin:0 0 10px;
      font-size:14px;
      color:#cfe0ff;
      letter-spacing:.2px;
    }

    .muted{ color:var(--muted); font-size:12px; line-height:1.45; }

    ul{ margin:8px 0 0; padding-left:18px; }
    li{ margin:8px 0; }

    .kws li{
      margin:10px 0;
      padding:10px 10px;
      border-radius:12px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .kw-head{
      display:flex;
      gap:8px;
      align-items:baseline;
      flex-wrap:wrap;
    }
    .kw-en{
      font-weight:700;
      font-size:14px;
      color:#ffffff;
    }
    .kw-ja{
      color:var(--muted);
      font-size:12px;
    }
    .kw-uses{
      margin-top:6px;
      color:#d9e4ff;
      font-size:12px;
      white-space:pre-wrap;
      opacity:.95;
    }

    .btn{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(90deg, var(--accent1), var(--accent2));
      color:#fff;
      font-weight:800;
      font-size:16px;
      letter-spacing:.2px;
      cursor:pointer;
    }
    .btn:active{ transform:translateY(1px); }

    .btn-secondary{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#fff;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
    }

    textarea{
      width:100%;
      height:220px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:#fff;
      padding:12px;
      font-size:12px;
      line-height:1.5;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      outline:none;
      resize:vertical;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .row .btn-secondary{ flex:1; min-width:180px; }

    /* tabs */
    .hide{ display:none; }

    .bottom-nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px;
      padding-bottom:calc(10px + env(safe-area-inset-bottom));
      background:rgba(11,18,32,.75);
      backdrop-filter: blur(14px);
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:space-between;
    }
    .tab{
      flex:1;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#fff;
      border-radius:14px;
      padding:12px 10px;
      font-weight:800;
      cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .tab.active{
      background:rgba(255,255,255,.14);
      border-color:rgba(255,255,255,.25);
    }

    /* toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:92px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.75);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
    }
    .toast.show{ opacity:1; }

    .history-item{
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      margin:10px 0;
    }
    .history-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }
    .history-date{ color:var(--muted); font-size:12px; }
    .history-topic{ font-weight:800; }
    .history-kws{ color:#d9e4ff; font-size:12px; white-space:pre-wrap; }
    .small-link{
      font-size:12px;
      color:#b9d4ff;
      text-decoration:underline;
      cursor:pointer;
      background:none;
      border:none;
      padding:0;
    }
    .danger{
      border-color:rgba(255,80,80,.35);
      background:rgba(255,80,80,.10);
    }
  </style>
</head>

<body>

  <h1>SpeakUp</h1>
  <p class="sub">毎日20:00：未使用なら通知 → ChatGPTで英会話（PWA化もOK）</p>

  <!-- TODAY -->
  <div id="viewToday">

    <div class="card">
      <h2>Prompts（順番に聞く）</h2>
      <ul id="promptList"></ul>
    </div>

    <div class="card">
      <h2>Keywords（タップで復習）</h2>
      <p class="muted">タップ：キーワードをコピーして、Notesに追記します（復習が楽）。</p>
      <ul id="kwList" class="kws"></ul>
    </div>

    <button id="btnSpeak" class="btn">Let&#39;s speak up!</button>
    <p class="muted" style="margin:10px 2px 0;">
      押すと：お題＋質問＋キーワードをChatGPTに渡して会話開始（履歴も保存）
    </p>

    <div class="card">
      <h2>Notes保存用（いつでも復習）</h2>
      <p class="muted">下は自由メモ。コピーしてNotes/Notion等へ。ショートカット連携もここからでOK。</p>
      <textarea id="notesArea" placeholder="- keyword = 日本語訳
uses: Example 1 / Example 2 / Example 3

[Chat Memo（会話の要点）]
- "></textarea>
      <div style="height:10px;"></div>
      <div class="row">
        <button id="btnCopyNotes" class="btn-secondary">コピー</button>
        <button id="btnClearNotes" class="btn-secondary danger">Notesクリア</button>
      </div>
    </div>

  </div>

  <!-- HISTORY -->
  <div id="viewHistory" class="hide">
    <div class="card">
      <h2>History</h2>
      <p class="muted">直近20件。Speakボタン実行時に保存されます。</p>
      <div class="row">
        <button id="btnExportHistory" class="btn-secondary">履歴をコピー</button>
        <button id="btnClearHistory" class="btn-secondary danger">履歴を全削除</button>
      </div>
      <div style="height:12px;"></div>
      <div id="historyList"></div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="viewSettings" class="hide">
    <div class="card">
      <h2>Settings</h2>
      <p class="muted">
        WebだけではiOSの「毎日20:00通知」を確実に出せないので、通知はショートカット側で実装する前提。
        ここはアプリ側のデータ管理だけ置いてあります。
      </p>
      <div style="height:10px;"></div>
      <div class="row">
        <button id="btnResetAll" class="btn-secondary danger">全データ初期化（Notes + 履歴）</button>
      </div>
      <div style="height:14px;"></div>
      <p class="muted">
        ※ Home画面に追加（PWA化）すると見た目はアプリっぽく使えます。<br>
        ※ 追加の改善（リマインダー連携・テンプレ拡張・ショートカット連携強化）もここから育てられる。
      </p>
    </div>
  </div>

  <!-- bottom nav -->
  <div class="bottom-nav">
    <div id="tab1" class="tab active">Today</div>
    <div id="tab2" class="tab">History</div>
    <div id="tab3" class="tab">Settings</div>
  </div>

  <div id="toast" class="toast">Copied</div>

  <script>
    // ========= Data =========
    const TOPIC = {
      title: "Discussing ADR Strategy with Fusion Hotels",
      guide: "Fusionチーム向け。ADR/OCC/OTA/レートミックスを英語で説明する練習。",
      prompts: [
        "What factors influence ADR in your market?",
        "How do you balance ADR and occupancy?",
        "What pricing strategy works best in Vietnam?",
        "How do OTAs affect ADR performance?"
      ],
      keywords: [
        { en:"pricing strategy", ja:"価格戦略", uses:"We adjust pricing strategy.\nStrategy depends on demand.\nPricing strategy is flexible." },
        { en:"demand", ja:"需要", uses:"Demand is growing.\nWe forecast demand.\nDemand changes seasonally." },
        { en:"OTA", ja:"オンライン旅行代理店", uses:"OTA costs are rising.\nOTA drives volume.\nOTA strategy matters." },
        { en:"rate mix", ja:"料金構成", uses:"Rate mix changed.\nMix affects revenue.\nAnalyze rate mix monthly." }
      ]
    };

    // ========= Utilities =========
    const $ = (id) => document.getElementById(id);

    function toast(msg){
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 900);
    }

    async function copyText(text){
      try{
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      }catch(e){}
      // fallback
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      }catch(e){
        return false;
      }
    }

    function todayStr(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function loadJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        if (!v) return fallback;
        return JSON.parse(v);
      }catch(e){
        return fallback;
      }
    }
    function saveJSON(key, value){
      try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){}
    }

    // ========= Render =========
    function renderTopic(){
      // prompts
      const p = $("promptList");
      p.innerHTML = "";
      TOPIC.prompts.forEach((q) => {
        const li = document.createElement("li");
        li.textContent = q;
        p.appendChild(li);
      });

      // keywords
      const k = $("kwList");
      k.innerHTML = "";
      TOPIC.keywords.forEach((kw) => {
        const li = document.createElement("li");

        const head = document.createElement("div");
        head.className = "kw-head";

        const en = document.createElement("div");
        en.className = "kw-en";
        en.textContent = kw.en;

        const ja = document.createElement("div");
        ja.className = "kw-ja";
        ja.textContent = `= ${kw.ja}`;

        head.appendChild(en);
        head.appendChild(ja);

        const uses = document.createElement("div");
        uses.className = "kw-uses";
        uses.textContent = `uses:\n${kw.uses}`;

        li.appendChild(head);
        li.appendChild(uses);

        li.addEventListener("click", async () => {
          // Notesに追記する（コピーもする）
          const add = `- ${kw.en} = ${kw.ja}\nuses: ${kw.uses.replace(/\n/g, " / ")}\n`;
          const notes = $("notesArea");
          notes.value = (notes.value ? notes.value.replace(/\s*$/,"") + "\n" : "") + add + "\n";
          const ok = await copyText(`${kw.en} = ${kw.ja}\n${kw.uses}`);
          toast(ok ? `Copied: ${kw.en}` : `Added: ${kw.en}`);
          persistNotes();
        });

        k.appendChild(li);
      });
    }

    // ========= Tabs =========
    function switchTab(num){
      $("viewToday").className    = (num === 1) ? "" : "hide";
      $("viewHistory").className  = (num === 2) ? "" : "hide";
      $("viewSettings").className = (num === 3) ? "" : "hide";

      $("tab1").className = "tab" + (num === 1 ? " active" : "");
      $("tab2").className = "tab" + (num === 2 ? " active" : "");
      $("tab3").className = "tab" + (num === 3 ? " active" : "");

      if (num === 2) renderHistory();
    }

    // ========= Notes =========
    const NOTES_KEY = "speakup_notes";
    function persistNotes(){
      try{ localStorage.setItem(NOTES_KEY, $("notesArea").value || ""); }catch(e){}
    }
    function loadNotes(){
      try{
        const v = localStorage.getItem(NOTES_KEY);
        if (v !== null) $("notesArea").value = v;
      }catch(e){}
    }

    // ========= History =========
    const HISTORY_KEY = "speakup_history";
    function addHistory(entry){
      const history = loadJSON(HISTORY_KEY, []);
      history.unshift(entry);
      if (history.length > 20) history.length = 20;
      saveJSON(HISTORY_KEY, history);
    }

    function renderHistory(){
      const history = loadJSON(HISTORY_KEY, []);
      const root = $("historyList");
      root.innerHTML = "";

      if (!history.length){
        const p = document.createElement("p");
        p.className = "muted";
        p.textContent = "まだ履歴がありません。Todayで Let's speak up! を押すと保存されます。";
        root.appendChild(p);
        return;
      }

      history.forEach((h) => {
        const box = document.createElement("div");
        box.className = "history-item";

        const top = document.createElement("div");
        top.className = "history-top";

        const left = document.createElement("div");
        left.innerHTML = `<div class="history-topic">${escapeHtml(h.topic || "(no topic)")}</div>`;

        const right = document.createElement("div");
        right.className = "history-date";
        right.textContent = h.date || "";

        top.appendChild(left);
        top.appendChild(right);

        const kws = document.createElement("div");
        kws.className = "history-kws";
        kws.textContent = h.keywords || "";

        const btnRow = document.createElement("div");
        btnRow.style.marginTop = "8px";

        const btn = document.createElement("button");
        btn.className = "small-link";
        btn.textContent = "この回のプロンプトをコピー";
        btn.addEventListener("click", async () => {
          const prompt = buildPromptText();
          const ok = await copyText(prompt);
          toast(ok ? "Prompt copied" : "Copy failed");
        });

        btnRow.appendChild(btn);

        box.appendChild(top);
        box.appendChild(kws);
        box.appendChild(btnRow);
        root.appendChild(box);
      });
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function buildPromptText(){
      const kwLines = TOPIC.keywords.map(k => `- ${k.en}: ${k.ja}`).join("\n");
      const promptLines = TOPIC.prompts.map((q,i)=> `${i+1}) ${q}`).join("\n");
      return [
        "Let's practice English speaking.",
        "",
        `Today's topic: ${TOPIC.title}`,
        "",
        "Rules: Ask me the questions one by one. After each answer, correct my English briefly and suggest a more natural alternative.",
        "",
        "Questions:",
        promptLines,
        "",
        "Keywords to try using:",
        kwLines,
        "",
        "Start with question 1."
      ].join("\n");
    }

    function openChatGPTWithPrompt(prompt){
      // まずはコピー（ブラウザ制限対策）
      copyText(prompt).then(ok => {
        toast(ok ? "Prompt copied (opening ChatGPT)" : "Opening ChatGPT");
      });

      // ChatGPT のURLへ
      const url = "https://chatgpt.com/?prompt=" + encodeURIComponent(prompt);
      window.open(url, "_blank");
    }

    // ========= Actions =========
    function bindEvents(){
      $("tab1").addEventListener("click", () => switchTab(1));
      $("tab2").addEventListener("click", () => switchTab(2));
      $("tab3").addEventListener("click", () => switchTab(3));

      $("notesArea").addEventListener("input", persistNotes);

      $("btnCopyNotes").addEventListener("click", async () => {
        const ok = await copyText($("notesArea").value || "");
        toast(ok ? "Copied notes" : "Copy failed");
      });

      $("btnClearNotes").addEventListener("click", () => {
        $("notesArea").value = "";
        persistNotes();
        toast("Notes cleared");
      });

      $("btnSpeak").addEventListener("click", () => {
        const prompt = buildPromptText();

        // 履歴保存
        const kws = TOPIC.keywords.map(k => `${k.en} / ${k.ja}`).join("\n");
        addHistory({ date: todayStr(), topic: TOPIC.title, keywords: kws });

        // ChatGPTへ
        openChatGPTWithPrompt(prompt);
      });

      $("btnClearHistory").addEventListener("click", () => {
        saveJSON(HISTORY_KEY, []);
        renderHistory();
        toast("History cleared");
      });

      $("btnExportHistory").addEventListener("click", async () => {
        const history = loadJSON(HISTORY_KEY, []);
        const text = history.map(h => `# ${h.date} - ${h.topic}\n${h.keywords}\n`).join("\n");
        const ok = await copyText(text || "");
        toast(ok ? "History copied" : "Copy failed");
      });

      $("btnResetAll").addEventListener("click", () => {
        try{
          localStorage.removeItem(NOTES_KEY);
          localStorage.removeItem(HISTORY_KEY);
        }catch(e){}
        $("notesArea").value = "";
        toast("Reset done");
      });
    }

    // ========= Init =========
    (function init(){
      renderTopic();
      loadNotes();
      bindEvents();
      switchTab(1);

      // Service Worker (optional) - ファイルが無くても落ちないようにガード
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js").catch(() => {});
        });
      }
    })();
  </script>

</body>
</html>
