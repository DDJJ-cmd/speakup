<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <!-- iPhone向け -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="SpeakUp" />

  <!-- PWA（任意：manifest / icon が無いなら消してOK） -->
  <meta name="theme-color" content="#0b1220" />

  <title>SpeakUp</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b2e;
      --panel2:#0e1a2a;
      --line:rgba(255,255,255,.10);
      --text:#e9eefc;
      --muted:#a9b6d3;
      --accent:#6ee7ff;
      --btnbg:linear-gradient(90deg, rgba(110,231,255,.18), rgba(124,255,166,.14));
      --btnbg2:rgba(255,255,255,.05);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;

      /* 見出し用：新聞っぽいセリフ */
      --title-font: "Times New Roman", Georgia, "New York", "Iowan Old Style", serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, system-ui, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:18px 14px 18px;
    }

    header{
      margin-bottom:10px;
      text-align:center; /* ★中央寄せ */
    }
    h1{
      margin:6px 0 0 0;
      font-family:var(--title-font); /* ★新聞っぽいフォント */
      font-size:34px;
      font-weight:800;
      letter-spacing:.6px;
      line-height:1.05;
    }
    .sub{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      margin:12px 0;
      box-shadow:var(--shadow);
    }
    .card h2{
      margin:0 0 8px 0;
      font-size:16px;
    }
    .card h3{
      margin:12px 0 6px;
      font-size:14px;
      color:var(--accent);
    }
    .muted{color:var(--muted)}
    .small{font-size:12px}

    .btn{
      width:100%;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--btnbg);
      color:#fff;
      font-weight:700;
      font-size:16px;
      cursor:pointer;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn-sec{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--btnbg2);
      color:var(--text);
      font-size:14px;
      cursor:pointer;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center; /* ★中央寄せ */
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      font-size:12px;
      color:var(--muted);
    }

    ul.kws{
      margin:10px 0 0;
      padding-left:18px;
    }
    ul.kws li{
      margin:8px 0;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.02);
      list-style:disc;
    }
    .kw-title{
      font-weight:700;
      margin-bottom:6px;
    }
    .kw-uses{
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
      white-space:pre-line;
    }

    textarea{
      width:100%;
      min-height:190px;
      resize:vertical;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:12px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      line-height:1.5;
      outline:none;
    }

    /* 下部タブ */
    .tabs{
      display:flex;
      gap:10px;
      margin-top:14px;
    }
    .tab{
      flex:1;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      text-align:center;
      user-select:none;
    }
    .tab.active{
      background:rgba(110,231,255,.12);
      border-color:rgba(110,231,255,.35);
    }

    .hide{display:none}

    /* トースト */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.72);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 10px 25px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:9999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    /* モバイル余白 */
    .safe-bottom{
      height:env(safe-area-inset-bottom);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>SpeakUp</h1>
      <div class="sub">
        毎日20:00：未使用なら通知 → ChatGPTで英会話
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="pill" id="statusPill">状態：-</div>
        <div class="pill" id="topicPill">今日のお題：-</div>
      </div>
    </header>

    <!-- Today -->
    <section id="viewToday">
      <div class="card">
        <h2>Prompts（順番に聞く）</h2>
        <div id="promptsBox" class="muted small">-</div>

        <h3>Keywords（タップで復習）</h3>
        <div class="muted small">押すと：お題→キーワード→ChatGPTを開いて会話開始（履歴も保存）</div>
        <ul class="kws" id="kwList"></ul>
      </div>

      <button class="btn" id="btnSpeak">Let's speak up!</button>

      <div class="card">
        <h2>Notes保存用（いつでも復習）</h2>
        <div class="muted small">下は自由に。コピーしてNotes/Notion等へ。ショートカット連携もここからOK。</div>
        <div style="height:10px"></div>
        <textarea id="notesArea" placeholder="- keyword = 日本語訳&#10;uses: Example 1 / Example 2 / Example 3&#10;&#10;[Chat Memo（会話の要点）]&#10;-"></textarea>

        <div style="height:10px"></div>
        <button class="btn-sec" id="btnCopyNotes">Notesをコピー</button>
      </div>
    </section>

    <!-- History -->
    <section id="viewHistory" class="hide">
      <div class="card">
        <h2>History</h2>
        <div class="muted small">直近20件（ローカル保存）</div>
        <div style="height:10px"></div>
        <textarea id="historyArea" readonly></textarea>
        <div style="height:10px"></div>
        <button class="btn-sec" id="btnClearHistory">履歴を全削除</button>
      </div>
    </section>

    <!-- Settings -->
    <section id="viewSettings" class="hide">
      <div class="card">
        <h2>Settings</h2>
        <div class="muted small">必要最低限の設定だけ（ローカル保存）</div>
        <div style="height:10px"></div>

        <div class="row">
          <div class="pill">通知（iPhoneショートカット側で実装）</div>
          <div class="pill">データ保存：localStorage</div>
        </div>

        <div style="height:14px"></div>
        <button class="btn-sec" id="btnResetNotes">Notes欄を初期化</button>
      </div>
    </section>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" id="tab1" onclick="switchTab(1)">Today</div>
      <div class="tab" id="tab2" onclick="switchTab(2)">History</div>
      <div class="tab" id="tab3" onclick="switchTab(3)">Settings</div>
    </div>

    <div class="safe-bottom"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // =========================
    // 30日分（HMJ専用）日替わりトピック
    // =========================
    const TOPICS = [
      {
        title: "Discussing ADR Strategy with Fusion Hotels",
        guide: "ADRとOCCのバランス、OTA影響、レートミックスの話を練習。",
        prompts: [
          "What factors influence ADR in your market?",
          "How do you balance ADR and occupancy?",
          "What pricing strategy works best in Vietnam?",
          "How do OTAs affect ADR performance?"
        ],
        keywords: [
          { en: "ADR", ja: "平均客室単価", uses: "ADR increased due to higher demand. / ADR declined because of discounts. / We monitor ADR daily." },
          { en: "pricing strategy", ja: "価格戦略", uses: "We adjust pricing strategy. / Strategy depends on demand. / Pricing strategy is flexible." },
          { en: "demand", ja: "需要", uses: "Demand is growing. / We forecast demand. / Demand changes seasonally." },
          { en: "OTA", ja: "オンライン旅行代理店", uses: "OTA costs are rising. / OTA drives volume. / OTA strategy matters." },
          { en: "rate mix", ja: "レートミックス", uses: "Rate mix shifted to OTA. / Rate mix affects revenue quality. / We should optimize rate mix." }
        ]
      },
      {
        title: "Explaining Flow-Through to International Teams",
        guide: "売上増減に対してGOPがどう動くかを説明する練習。",
        prompts: [
          "How do you define Flow-Through in simple terms?",
          "Why is ADR-driven growth usually better for Flow-Through?",
          "What costs reduce Flow-Through the most in Rooms?",
          "How do you separate ADR vs OCC impact on profit?"
        ],
        keywords: [
          { en: "flow-through", ja: "売上増減の利益転換率", uses: "Flow-through improved vs budget. / Flow-through weakened due to costs. / We track flow-through monthly." },
          { en: "variable cost", ja: "変動費", uses: "Variable costs increased with occupancy. / Housekeeping is a key variable cost. / OTA fees are variable." },
          { en: "occupancy", ja: "稼働率", uses: "Occupancy improved but ADR fell. / Occupancy drives volume. / We manage occupancy carefully." },
          { en: "profitability", ja: "収益性", uses: "Profitability depends on rate quality. / We focus on profitability, not just revenue. / Profitability improved." },
          { en: "driver", ja: "要因/ドライバー", uses: "ADR is the main driver. / OCC is a volume driver. / We identify key drivers." }
        ]
      },
      {
        title: "Monthly Performance Report: Key Messages",
        guide: "上司・GM向けに短く要点を伝える練習。",
        prompts: [
          "What is the top message for this month?",
          "Which department drove the variance vs budget?",
          "What is your action plan for next month?",
          "What risks should leadership know?"
        ],
        keywords: [
          { en: "variance", ja: "差異", uses: "Variance vs budget was driven by Rooms. / We explain key variances. / Variance narrowed this month." },
          { en: "action plan", ja: "対応策", uses: "We have an action plan. / Action plan focuses on ADR. / We will update the action plan." },
          { en: "risk", ja: "リスク", uses: "There is a risk of ADR dilution. / Risk is increasing. / We mitigate the risk." },
          { en: "headline", ja: "要点/見出し", uses: "The headline is ADR pressure. / Keep the headline simple. / Headline message is clear." },
          { en: "prioritize", ja: "優先する", uses: "We prioritize high-impact actions. / Prioritize revenue quality. / We need to prioritize." }
        ]
      },
      {
        title: "OTA Coupon Impact and ADR Dilution",
        guide: "OTAクーポンでADRが薄まる状況を説明する。",
        prompts: [
          "How do coupons affect ADR and net revenue?",
          "How can we control discount dependency?",
          "What metrics show ADR dilution clearly?",
          "How do you align OTA strategy with profitability?"
        ],
        keywords: [
          { en: "ADR dilution", ja: "ADRの希薄化", uses: "ADR dilution came from discounting. / Coupons accelerated ADR dilution. / We must control ADR dilution." },
          { en: "discount dependency", ja: "値引き依存", uses: "Discount dependency is risky. / We should reduce discount dependency. / Dependency lowers long-term ADR." },
          { en: "channel strategy", ja: "チャネル戦略", uses: "Channel strategy drives profitability. / Direct channel is healthier. / We need clear channel strategy." },
          { en: "net revenue", ja: "実質売上（控除後）", uses: "Net revenue is more important than gross. / Net revenue dropped due to fees. / We track net revenue." },
          { en: "commission", ja: "手数料", uses: "OTA commission is high. / Commission impacts margin. / We negotiate commission." }
        ]
      }
    ];

    // 30件未満の時は自動で埋める（簡易）
    while (TOPICS.length < 30) {
      const i = TOPICS.length + 1;
      TOPICS.push({
        title: `HMJ Daily Topic ${i}`,
        guide: "ホテル業務向け英会話トピック（暫定）",
        prompts: [
          "What is the main driver this month?",
          "Which KPI should we watch closely?",
          "What action will improve GOP the most?",
          "How do you explain this to an international team?"
        ],
        keywords: [
          { en: "GOP", ja: "総営業利益", uses: "GOP improved. / GOP fell below budget. / We protect GOP." },
          { en: "RevPAR", ja: "販売可能客室あたり売上", uses: "RevPAR increased. / RevPAR missed budget. / We track RevPAR." },
          { en: "forecast", ja: "予測", uses: "We updated the forecast. / Forecast risk is high. / Forecast looks stable." },
          { en: "cost control", ja: "コスト管理", uses: "Cost control is critical. / We strengthened cost control. / Cost control improved margin." }, /* ★ハングル除去 */
          { en: "alignment", ja: "整合/合意", uses: "We align on priorities. / Alignment is needed. / We need alignment." }
        ]
      });
    }

    function getTodayIndex(){
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth() + 1;
      const d = now.getDate();
      const key = y * 10000 + m * 100 + d;
      return key % TOPICS.length;
    }

    function renderTopic(){
      const idx = getTodayIndex();
      const topic = TOPICS[idx];

      document.getElementById('topicPill').textContent = `今日のお題：${topic.title}`;

      const promptsBox = document.getElementById('promptsBox');
      promptsBox.textContent =
        `Questions:\n` +
        topic.prompts.map((p, i) => `${i+1}) ${p}`).join('\n') +
        `\n\nKeywords to try using: ` +
        topic.keywords.map(k => k.en).join(', ') +
        `\n\nStart with question 1.`;

      const ul = document.getElementById('kwList');
      ul.innerHTML = '';
      topic.keywords.forEach(k => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="kw-title">${escapeHtml(k.en)} <span class="muted">= ${escapeHtml(k.ja)}</span></div>
          <div class="kw-uses"><span class="muted">uses:</span>\n${escapeHtml(k.uses)}</div>
        `;
        ul.appendChild(li);
      });

      const notesArea = document.getElementById('notesArea');
      if (!notesArea.value || notesArea.value.trim() === "" || notesArea.value.includes("- keyword = 日本語訳")) {
        const lines = topic.keywords.map(k =>
          `- ${k.en} = ${k.ja}\nuses: ${k.uses}`
        ).join('\n\n');
        notesArea.value =
`${lines}

[Chat Memo（会話の要点）]
-`;
      }
    }

    function updateStatus(){
      document.getElementById('statusPill').textContent = '状態：未利用';
    }

    function buildChatGPTPrompt(){
      const idx = getTodayIndex();
      const topic = TOPICS[idx];
      const keywords = topic.keywords.map(k => k.en).join(', ');

      return `Let's practice English speaking.\n\n` +
        `Today's topic: ${topic.title}\n\n` +
        `Rules: Ask me the questions one by one. After each answer, correct my English briefly and suggest a more natural alternative.\n\n` +
        `Questions:\n` +
        topic.prompts.map((p,i)=>`${i+1}) ${p}`).join('\n') +
        `\n\nKeywords to try using: ${keywords}\n\n` +
        `Start with question 1.`;
    }

    function openChatGPT(){
      const prompt = buildChatGPTPrompt();
      const url = "https://chatgpt.com/?prompt=" + encodeURIComponent(prompt);
      window.open(url, "_blank");
    }

    async function copyNotes(){
      const text = document.getElementById('notesArea').value || '';
      if (!text.trim()){
        toast('Notesが空です');
        return;
      }
      try{
        if (navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.getElementById('notesArea');
          ta.focus();
          ta.select();
          document.execCommand('copy');
          ta.setSelectionRange(0,0);
        }
        toast('Notesをコピーしました');
      } catch(e){
        toast('コピーに失敗：ブラウザの権限を確認');
      }
    }

    function loadHistory(){
      const histData = localStorage.getItem('speakup_history');
      const history = histData ? JSON.parse(histData) : [];
      const out = history.map(h =>
        `- ${h.date}\n  topic: ${h.topic}\n  keywords: ${h.keywords}\n`
      ).join('\n');
      document.getElementById('historyArea').value = out || "(empty)";
    }

    function saveHistory(){
      const today = getDateString();
      const idx = getTodayIndex();
      const topic = TOPICS[idx];

      const histData = localStorage.getItem('speakup_history');
      const history = histData ? JSON.parse(histData) : [];

      const kws = topic.keywords.map(k => k.en).join(', ');
      history.unshift({ date: today, topic: topic.title, keywords: kws });

      if (history.length > 20) history.length = 20;
      localStorage.setItem('speakup_history', JSON.stringify(history));
    }

    function clearHistory(){
      localStorage.removeItem('speakup_history');
      loadHistory();
      toast('履歴を削除しました');
    }

    function resetNotes(){
      document.getElementById('notesArea').value =
`- keyword = 日本語訳
uses: Example 1 / Example 2 / Example 3

[Chat Memo（会話の要点）]
-`;
      toast('Notes欄を初期化しました');
    }

    function switchTab(num){
      document.getElementById('viewToday').className = (num===1) ? '' : 'hide';
      document.getElementById('viewHistory').className = (num===2) ? '' : 'hide';
      document.getElementById('viewSettings').className = (num===3) ? '' : 'hide';

      document.getElementById('tab1').className = 'tab' + (num===1 ? ' active' : '');
      document.getElementById('tab2').className = 'tab' + (num===2 ? ' active' : '');
      document.getElementById('tab3').className = 'tab' + (num===3 ? ' active' : '');

      if (num===2) loadHistory();
    }

    function getDateString(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>t.classList.remove('show'), 1600);
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    document.getElementById('btnSpeak').addEventListener('click', ()=>{
      saveHistory();
      openChatGPT();
      toast('ChatGPTを開きます');
    });

    document.getElementById('btnCopyNotes').addEventListener('click', copyNotes);
    document.getElementById('btnClearHistory').addEventListener('click', clearHistory);
    document.getElementById('btnResetNotes').addEventListener('click', resetNotes);

    window.onload = function(){
      updateStatus();
      renderTopic();
    };
  </script>
</body>
</html>
